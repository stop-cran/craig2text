on: [push]
name: Linux-container

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@main
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Docker build
      run: |
        LOCAL_IMAGE_ID=craig2text:0.0.${{ github.run_number }}
        REMOTE_IMAGE_ID=ghcr.io/${{ github.actor }}/$LOCAL_IMAGE_ID
        docker build . --tag $LOCAL_IMAGE_ID
        docker tag $LOCAL_IMAGE_ID $REMOTE_IMAGE_ID
        docker push $REMOTE_IMAGE_ID
    - uses: Azure/login@v1
      with:
        creds: '{"clientId":"${{ secrets.CLIENT_ID }}","clientSecret":"${{ secrets.CLIENT_SECRET }}","subscriptionId":"${{ secrets.SUBSCRIPTION_ID }}","tenantId":"${{ secrets.TENANT_ID }}"}'
    - name: List Azure container jobs (test)
      run: |
        az containerapp job list
